{% extends "base.html" %}

{% block title %}Detailed Statistics - C Programming Practice{% endblock %}

{% block content %}
<div class="stats-page">
    <h1>Detailed Statistics</h1>

    <div class="overall-stats">
        <h2>Overall Performance</h2>
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-value">{{ progress.overall_accuracy }}%</div>
                <div class="stat-label">Overall Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ attempts_count }}</div>
                <div class="stat-label">Total Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ (total_time / 60) | int }}m</div>
                <div class="stat-label">Total Practice Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ avg_time | int }}s</div>
                <div class="stat-label">Avg Time/Question</div>
            </div>
        </div>
    </div>

    <div class="category-breakdown">
        <h2>Category Performance</h2>
        <div class="category-stats-grid">
            {% for category, stats in category_stats.items() %}
            <div class="category-stat-card">
                <h3>{{ category.replace('_', ' ').title() }}</h3>
                <div class="stat-detail">
                    <span class="label">Accuracy:</span>
                    <span class="value">
                        {% if stats.total > 0 %}
                        {{ ((stats.correct / stats.total) * 100) | int }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
                <div class="stat-detail">
                    <span class="label">Questions:</span>
                    <span class="value">{{ stats.total }}</span>
                </div>
                <div class="stat-detail">
                    <span class="label">Correct:</span>
                    <span class="value">{{ stats.correct }}</span>
                </div>
                <div class="stat-detail">
                    <span class="label">Total Time:</span>
                    <span class="value">{{ (stats.time / 60) | int }}m {{ stats.time % 60 }}s</span>
                </div>
                <div class="progress-bar-small">
                    <div class="progress-fill" style="width: {% if stats.total > 0 %}{{ ((stats.correct / stats.total) * 100) | int }}{% else %}0{% endif %}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="stats-charts">
        <h2>Performance Trends</h2>
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Accuracy Over Time</h3>
                <p class="chart-summary" id="accuracySummary">
                    Daily accuracy over the last 14 days. Missing days have no data.
                </p>
                <canvas id="accuracyChart" height="160" aria-describedby="accuracySummary"></canvas>
            </div>
            <div class="chart-card">
                <h3>Category Accuracy</h3>
                <p class="chart-summary" id="categorySummary">
                    {% for item in category_summary %}
                        {{ item }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <canvas id="categoryChart" height="160" aria-describedby="categorySummary"></canvas>
            </div>
        </div>
    </div>

    <div class="weak-areas">
        <h2>Areas for Improvement</h2>
        <ul>
            {% for area in progress.weak_areas %}
            <li class="weak-area-item">
                <strong>{{ area.replace('_', ' ').title() }}</strong>
                {% if area in category_stats %}
                - {{ ((category_stats[area].correct / category_stats[area].total) * 100) | int }}% accuracy
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="action-buttons">
        <a href="{{ url_for('practice.start_practice') }}" class="btn-primary btn-large">
            Start Practice
        </a>
        <a href="{{ url_for('progress.dashboard') }}" class="btn-secondary btn-large">
            Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const trendLabels = {{ trend_labels | tojson }};
    const trendAccuracy = {{ trend_accuracy | tojson }};
    const categoryLabels = {{ category_labels | tojson }};
    const categoryAccuracy = {{ category_accuracy | tojson }};

    const accuracyCtx = document.getElementById('accuracyChart');
    if (accuracyCtx) {
        new Chart(accuracyCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Accuracy (%)',
                    data: trendAccuracy,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.2)',
                    tension: 0.3,
                    spanGaps: true
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Accuracy (%)',
                    data: categoryAccuracy,
                    backgroundColor: '#38bdf8'
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
</script>
{% endblock %}
